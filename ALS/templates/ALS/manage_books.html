{% load static %}
<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Manage Books | Smart Library</title>
  <link href="https://cdn.jsdelivr.net/npm/tailwindcss@3.3.2/dist/tailwind.min.css" rel="stylesheet">
  <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
</head>
<body class="bg-gray-100 font-sans">

<div class="container mx-auto mt-12 px-4">
  <h1 class="text-4xl font-bold text-gray-800 mb-6">Manage Books</h1>

  <!-- Add / Edit Book Form -->
  <div class="bg-white shadow-xl rounded-3xl p-6 mb-6">
    <h2 class="text-2xl font-semibold text-gray-700 mb-4">Add / Edit Book</h2>
    <form id="bookForm" class="grid grid-cols-1 md:grid-cols-2 gap-4">
      <input type="hidden" id="bookId">
      <input type="text" id="title" placeholder="Book Title" class="px-4 py-2 border rounded-lg w-full">
      <input type="text" id="category" placeholder="Category" class="px-4 py-2 border rounded-lg w-full">
      <input type="text" id="otp_code" placeholder="OTP Code" class="px-4 py-2 border rounded-lg w-full">
      <input type="text" id="img" placeholder="Image URL" class="px-4 py-2 border rounded-lg w-full">
      <button type="submit" class="bg-blue-500 hover:bg-blue-600 text-white px-6 py-2 rounded-xl shadow-lg col-span-full">Save Book</button>
    </form>
  </div>

  <!-- Search -->
  <div class="mb-4">
    <input type="text" id="searchInput" placeholder="Search by ID, Title, Category..." 
      class="px-4 py-2 border rounded-lg shadow-sm w-full md:w-1/3 focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-blue-500">
  </div>

  <!-- Books Table -->
  <div class="bg-white shadow-2xl rounded-3xl overflow-hidden">
    <table class="min-w-full divide-y divide-gray-200">
      <thead class="bg-gradient-to-r from-blue-500 to-blue-600 text-white text-sm uppercase tracking-wider">
        <tr>
          <th class="py-3 px-6">ID</th>
          <th class="py-3 px-6">Title</th>
          <th class="py-3 px-6">Category</th>
          <th class="py-3 px-6">OTP Code</th>
          <th class="py-3 px-6">Image</th>
          <th class="py-3 px-6 text-center">Actions</th>
        </tr>
      </thead>
      <tbody class="text-gray-700 text-sm" id="booksTable">
        <!-- Books injected by JS -->
      </tbody>
    </table>
  </div>
</div>

<script>
let books = [];
const booksJsonPath = "{% static 'books.json' %}";

// Fetch initial books
fetch(booksJsonPath)
  .then(res => res.json())
  .then(data => { books = data; renderBooks(); });

// Render Books Table
function renderBooks() {
  const tbody = document.getElementById("booksTable");
  tbody.innerHTML = "";
  books.forEach(book => {
    tbody.innerHTML += `
      <tr class="hover:bg-gray-50 transition">
        <td class="py-4 px-6 font-medium">${book.id}</td>
        <td class="py-4 px-6">${book.title}</td>
        <td class="py-4 px-6">${book.category}</td>
        <td class="py-4 px-6">${book.otp_code}</td>
        <td class="py-4 px-6"><img src="${book.img}" alt="${book.title}" class="w-12 h-12 object-cover rounded"></td>
        <td class="py-4 px-6 text-center space-x-2">
          <button onclick="editBook(${book.id})" class="bg-yellow-400 hover:bg-yellow-500 text-white px-3 py-1 rounded shadow"><i class="fa fa-edit"></i></button>
          <button onclick="deleteBook(${book.id})" class="bg-red-500 hover:bg-red-600 text-white px-3 py-1 rounded shadow"><i class="fa fa-trash"></i></button>
        </td>
      </tr>
    `;
  });
}

// Add / Edit Book Form
document.getElementById("bookForm").addEventListener("submit", function(e){
  e.preventDefault();
  const id = document.getElementById("bookId").value;
  const title = document.getElementById("title").value.trim();
  const category = document.getElementById("category").value.trim();
  const otp_code = document.getElementById("otp_code").value.trim();
  const img = document.getElementById("img").value.trim();

  if(!title || !category || !otp_code || !img) return alert("All fields required!");

  let payload;
  if(id){ // Editing existing book
    const book = books.find(b => b.id == id);
    book.title = title;
    book.category = category;
    book.otp_code = otp_code;
    book.img = img;
    payload = book;
  } else { // Adding new book
    payload = { title, category, otp_code, img };
  }

  fetch("/add_book/", {
    method: "POST",
    headers: {
      "Content-Type": "application/json",
      "X-CSRFToken": "{{ csrf_token }}"
    },
    body: JSON.stringify(payload)
  })
  .then(res => res.json())
  .then(res => {
    if(res.success){
      if(!id) books.push(res.book);
      renderBooks();
      alert(id ? "Book updated!" : "Book added!");
      this.reset();
      document.getElementById("bookId").value = "";
    } else {
      alert(res.message);
    }
  });
});

// Prefill form for editing
function editBook(id){
  const book = books.find(b => b.id == id);
  if(!book) return;
  document.getElementById("bookId").value = book.id;
  document.getElementById("title").value = book.title;
  document.getElementById("category").value = book.category;
  document.getElementById("otp_code").value = book.otp_code;
  document.getElementById("img").value = book.img;
}

// Delete book
function deleteBook(id){
  if(!confirm("Are you sure you want to delete this book?")) return;
  books = books.filter(b => b.id != id);
  renderBooks();
  fetch("/update_books/", {
    method: "POST",
    headers: {
      "Content-Type": "application/json",
      "X-CSRFToken": "{{ csrf_token }}"
    },
    body: JSON.stringify(books)
  });
}

// Search
document.getElementById("searchInput").addEventListener("input", function(){
  const filter = this.value.toLowerCase();
  const rows = document.querySelectorAll("#booksTable tr");
  rows.forEach(row => {
    const id = row.cells[0].textContent.toLowerCase();
    const title = row.cells[1].textContent.toLowerCase();
    const category = row.cells[2].textContent.toLowerCase();
    row.style.display = id.includes(filter) || title.includes(filter) || category.includes(filter) ? '' : 'none';
  });
});
</script>

</body>
</html>
